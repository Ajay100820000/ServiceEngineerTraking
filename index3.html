<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Service Engineer GPS Tracker (Depot-wise CSV)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin/>
<style>
  :root{--bg:#0b1222;--panel:#0f172a;--muted:#9aa4b2;--txt:#e5e7eb;--brand:#3b82f6;--good:#22c55e;--bad:#ef4444;--chip:#1f2937}
  *{box-sizing:border-box} html,body{height:100%;margin:0}
  body{background:linear-gradient(120deg,var(--bg),#0e1530 60%,#0b1222);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
  .wrap{max-width:1200px;margin:0 auto;padding:10px}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  h1{font-size:clamp(16px,3.5vw,22px);margin:0}
  .btn{padding:8px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:600}
  .primary{background:var(--brand);color:#fff}
  .danger{background:var(--bad);color:#fff}
  .good{background:var(--good);color:#fff}
  .card{background:rgba(15,23,42,.78);border:1px solid rgba(148,163,184,.15);border-radius:14px;overflow:hidden;box-shadow:0 8px 20px rgba(0,0,0,.35)}
  .card h3{margin:0;padding:10px;border-bottom:1px solid rgba(148,163,184,.15);font-size:13px;color:#cbd5e1}
  .card .content{padding:10px}
  .grid{display:grid;gap:10px}
  @media(min-width:900px){.grid{grid-template-columns:1.2fr .8fr}}
  label{font-size:12px;color:var(--muted)}
  input,select{width:100%;padding:9px;border-radius:8px;border:1px solid rgba(148,163,184,.18);background:#0d172b;color:var(--txt)}
  #map{width:100%;height:60vh;border-radius:10px}
  .log{background:#0b1222;border:1px solid rgba(148,163,184,.15);border-radius:10px;padding:10px;max-height:200px;overflow:auto;font-size:12px}
  #adminPanel{overflow-y:auto;max-height:70vh}
  .stat{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dashed rgba(148,163,184,.15);font-size:13px}
  .stat:last-child{border-bottom:0}
  table{width:100%;border-collapse:collapse;font-size:12px}
  th,td{padding:6px;border-bottom:1px solid rgba(148,163,184,.15)}
  #loginModal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:9999}
  .loginBox{background:#0f172a;padding:20px;border-radius:14px;width:320px;text-align:center}
  .loginBox input{margin:6px 0}
  .chip{display:inline-block;padding:6px 10px;font-size:12px;background:var(--chip);border-radius:999px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .muted{color:var(--muted);font-size:12px}
  .depot-btn{padding:6px 8px;border-radius:8px;border:1px solid rgba(148,163,184,.12);background:#0e1726;color:var(--txt);cursor:pointer}
  .small{font-size:12px;padding:6px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <img src="https://www.primeedge.in/images/logo.png" class="logo" style="height:34px">
    <h1>Engineer RIDE(Clime)</h1>
    <div style="display:flex;gap:8px;align-items:center">
      <input type="file" id="importEmployeesFile" accept=".csv" title="Import Employees CSV (IMEI,Name,Dept,Phone)" />
      <button class="btn" onclick="showLogin()">Admin</button>
    </div>
  </header>

  <div class="grid">
    <!-- Left: map + controls -->
    <section class="card">
      <h3>Map & Tracking</h3>
      <div class="content">
        <div class="row">
          <div>
            <label>Engineer (Employee)</label>
            <select id="employeeSelect">
              <option value="">‚Äî Select Employee ‚Äî</option>
            </select>
          </div>
          <div>
            <label>IMEI / Device ID (Auto)</label>
            <input id="imei" placeholder="will auto-fill when you choose employee" readonly />
          </div>
        </div>

        <div class="row" style="margin-top:8px">
          <div>
            <label>Depot (Required)</label>
            <select id="depotSelect">
              <option value="">‚Äî Select Depot ‚Äî</option>
            </select>
          </div>
          <div>
            <label>Depot Lat/Lng</label>
            <input id="depotLatLng" placeholder="Auto-filled" readonly />
          </div>
        </div>

        <div style="margin:12px 0;display:flex;gap:6px;flex-wrap:wrap">
          <button class="btn primary" id="btnStart">Start GPS</button>
          <button class="btn danger" id="btnStop">Stop</button>
          <button class="btn" id="btnClear">Clear</button>
          <button class="btn small" id="centerDepot">Center Depot</button>
        </div>

        <div class="chip" style="margin-bottom:8px">üìç Use on mobile for real GPS updates. Claim rate: ‚Çπ3 / km</div>
        <div id="map"></div>
      </div>
    </section>

    <!-- Right: status + admin -->
    <aside class="card">
      <h3>Status</h3>
      <div class="content">
        <div class="stat"><span>Status</span><strong id="status">Idle</strong></div>
        <div class="stat"><span>Lat/Lng</span><strong id="latlng">‚Äî</strong></div>
        <div class="stat"><span>Distance</span><strong id="dist">0 m</strong></div>
        <div class="stat"><span>Rate</span><strong>‚Çπ3/km</strong></div>
        <div class="stat"><span>Claim</span><strong id="claim">‚Çπ0</strong></div>
        <div class="stat"><span>Start Time</span><strong id="tStart">‚Äî</strong></div>
        <div class="stat"><span>End Time</span><strong id="tEnd">‚Äî</strong></div>
      </div>

      <!-- Admin only -->
      <div id="adminPanel" style="display:none;padding:10px">
        <div class="row">
          <button class="btn good" id="exportTodayAll">Export Today (All Depots)</button>
          <button class="btn danger" onclick="doLogout()">Logout</button>
        </div>

        <h3 style="margin-top:10px">üìÖ Export Depot-wise CSV by Date</h3>
        <div class="row">
          <div><label>Pick Date</label><input type="date" id="exportDate"></div>
          <div style="display:flex;align-items:end"><button class="btn" id="renderDepotButtons">Load Depot Buttons</button></div>
        </div>
        <div id="depotExport" style="margin:8px 0;display:flex;flex-wrap:wrap;gap:6px"></div>
        <div class="muted">Pick a date, click a depot to download CSV for that depot on that date.</div>

        <h3 style="margin-top:12px">üë• Employees</h3>
        <div class="row" style="margin-bottom:8px">
          <input type="file" id="empCsv" accept=".csv" />
          <button class="btn" id="downloadEmpTemplate">Download CSV Template</button>
        </div>
        <div style="max-height:200px;overflow:auto">
          <table>
            <thead><tr><th>IMEI</th><th>Name</th><th>Dept</th><th>Phone</th></tr></thead>
            <tbody id="empTable"></tbody>
          </table>
        </div>

        <h3 style="margin-top:10px">üìú Today‚Äôs Rides</h3>
        <div style="max-height:200px;overflow:auto">
          <table>
            <thead><tr><th>Date</th><th>Name</th><th>Depot</th><th>Start</th><th>End</th><th>Km</th><th>Claim(‚Çπ)</th></tr></thead>
            <tbody id="todayRides"></tbody>
          </table>
        </div>

        <h3>Event Log</h3>
        <div id="log" class="log"></div>
      </div>
    </aside>
  </div>
</div>

<!-- Admin Login -->
<div id="loginModal">
  <div class="loginBox">
    <h3>Admin Login</h3>
    <input id="username" placeholder="Username"/><br>
    <input id="password" type="password" placeholder="Password"/><br>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button class="btn primary" onclick="doLogin()">Login</button>
      <button class="btn" onclick="document.getElementById('loginModal').style.display='none'">Close</button>
    </div>
    <div id="loginMsg" style="color:var(--bad);margin-top:8px;font-size:12px"></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* =========== Config / Data =========== */
const CLAIM_RATE_PER_KM = 3;
const ADMIN_USER = "admin", ADMIN_PASS = "1234";

/* depots list */
const depots = [
  { name: "Adambakkam", lat: 13.0126, lng: 80.2010 },
  { name: "Adyar", lat: 13.0067, lng: 80.2570 },
  { name: "Anna Nagar West", lat: 13.0878, lng: 80.2065 },
  { name: "Anna Nagar East", lat: 13.0827, lng: 80.2200 },
  { name: "Alandur", lat: 13.0108, lng: 80.2016 },
  { name: "Ambattur Estate", lat: 13.1143, lng: 80.1501 },
  { name: "Avadi", lat: 13.1155, lng: 80.1010 },
  { name: "Basin Bridge", lat: 13.1104, lng: 80.2712 },
  { name: "Central Depot", lat: 13.0827, lng: 80.2707 },
  { name: "Chromepet - I", lat: 12.9486, lng: 80.1396 },
  { name: "Chromepet - II", lat: 12.9490, lng: 80.1420 },
  { name: "Ennore", lat: 13.2161, lng: 80.3203 },
  { name: "Iyyappanthangal", lat: 13.0463, lng: 80.1526 },
  { name: "Kannagi Nagar", lat: 12.9093, lng: 80.2418 },
  { name: "Kilambakkam", lat: 12.7361, lng: 80.0166 },
  { name: "K.K. Nagar", lat: 13.0356, lng: 80.2130 },
  { name: "Kundrathur", lat: 13.0103, lng: 80.0901 },
  { name: "Mandaveli", lat: 13.0275, lng: 80.2631 },
  { name: "Padiyanallur", lat: 13.2284, lng: 80.1770 },
  { name: "Perambur", lat: 13.1216, lng: 80.2342 },
  { name: "Perumbakkam", lat: 12.9079, lng: 80.1937 },
  { name: "Poonamallee", lat: 13.0486, lng: 80.1098 },
  { name: "Saidapet", lat: 13.0211, lng: 80.2201 },
  { name: "Tambaram", lat: 12.9250, lng: 80.1167 },
  { name: "T. Nagar", lat: 13.0418, lng: 80.2337 },
  { name: "Thiruvanmiyur", lat: 12.9869, lng: 80.2593 },
  { name: "Thiruvottriyur", lat: 13.1586, lng: 80.3018 },
  { name: "Tondiarpet - I", lat: 13.1200, lng: 80.2900 },
  { name: "Tondiarpet - II", lat: 13.1250, lng: 80.2950 },
  { name: "Vadapalani", lat: 13.0524, lng: 80.2120 },
  { name: "Vyasarpadi", lat: 13.1215, lng: 80.2548 }
];

/* sample employees - can be replaced by CSV import */
let employees = [
  { imei:"869785078151152", name:"Ajay", dept:"Logistics", phone:"8332039203" },
  { imei:"864530071068960", name:"Vamsi", dept:"Delivery", phone:"9876543211" },
  { imei:"860587058190013", name:"Anandh", dept:"Service", phone:"9840098400" },
  { imei:"862044052898090", name:"Bhargav", dept:"Service", phone:"9840098401" }
];

/* tracking state */
let map, depotMarkers = [], path=[], polyline=null, totalDist=0, watchId=null, marker=null, currentRide=null;

/* helper */
const todayStr = (d=new Date()) => d.toISOString().slice(0,10);
const fmt2 = n => (Math.round(n*100)/100).toFixed(2);

/* Rides stored in localStorage under 'rides' */
function loadRides(){ try{ return JSON.parse(localStorage.getItem('rides')||'[]'); }catch(e){return[]} }
function saveRides(r){ localStorage.setItem('rides', JSON.stringify(r)); }

/* ---------- map init ---------- */
map = L.map('map').setView([13.05,80.22],11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap'}).addTo(map);

/* add depot markers */
(function addDepotMarkers(){
  const icon = L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png', iconSize:[32,32] });
  depots.forEach(d=>{
    const m = L.marker([d.lat,d.lng],{icon}).addTo(map).bindPopup(`<b>${d.name}</b><br>${d.lat.toFixed(5)}, ${d.lng.toFixed(5)}`);
    depotMarkers.push(m);
  });
})();

/* ---------- UI rendering ---------- */
function renderEmployees(){
  const sel = document.getElementById('employeeSelect');
  const tbl = document.getElementById('empTable');
  sel.innerHTML = '<option value="">‚Äî Select Employee ‚Äî</option>';
  tbl.innerHTML = '';
  employees.forEach(emp=>{
    const o = document.createElement('option'); o.value = emp.imei; o.textContent = `${emp.name} (${emp.dept})`;
    sel.appendChild(o);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${emp.imei}</td><td>${emp.name}</td><td>${emp.dept}</td><td>${emp.phone}</td>`;
    tbl.appendChild(tr);
  });
}
function renderDepots(){
  const sel = document.getElementById('depotSelect');
  sel.innerHTML = '<option value="">‚Äî Select Depot ‚Äî</option>';
  depots.forEach(d=>{
    const o = document.createElement('option'); o.value = d.name; o.textContent = d.name;
    sel.appendChild(o);
  });
}
function renderTodayTable(){
  const tb = document.getElementById('todayRides');
  tb.innerHTML = '';
  const rides = loadRides().filter(r => r.date === todayStr());
  rides.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.date}</td><td>${r.employeeName}</td><td>${r.depot}</td>
      <td>${r.startISO?new Date(r.startISO).toLocaleTimeString():""}</td>
      <td>${r.endISO?new Date(r.endISO).toLocaleTimeString():""}</td>
      <td>${(r.distance_m/1000).toFixed(2)}</td><td>‚Çπ${r.claim_inr.toFixed(2)}</td>`;
    tb.appendChild(tr);
  });
}
function log(msg){
  const el = document.getElementById('log');
  el.innerHTML = `${new Date().toLocaleTimeString()} ‚Üí ${msg}<br>` + el.innerHTML;
}

/* initial render */
renderEmployees();
renderDepots();
document.getElementById('exportDate').value = todayStr();

/* ---------- Employee selection -> auto-fill IMEI ---------- */
document.getElementById('employeeSelect').addEventListener('change', e=>{
  const imeiField = document.getElementById('imei');
  const imei = e.target.value;
  imeiField.value = imei || '';
});

/* If admin imports employees via top file input, reuse same import routine */
document.getElementById('importEmployeesFile').addEventListener('change', function(evt){
  if(evt.target.files[0]) parseAndImportEmployeesFile(evt.target.files[0]);
});

/* ---------- Import employees CSV (empCsv) ---------- */
document.getElementById('empCsv').addEventListener('change', e=>{
  const f = e.target.files[0];
  if(!f) return;
  parseAndImportEmployeesFile(f);
});

function parseAndImportEmployeesFile(file){
  const reader = new FileReader();
  reader.onload = () => {
    const text = reader.result;
    // split lines and tolerant parse: IMEI,Name,Dept,Phone
    const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(l=>l!=="");
    lines.forEach((line, i) => {
      // naive CSV parse (handles very common cases)
      const parts = line.match(/(".*?"|[^,]+)(?=\s*,|\s*$)/g)?.map(s => s.replace(/^"|"$/g,'').trim()) || [];
      if(parts.length < 2) return;
      if(i===0 && /imei/i.test(parts[0]) && /name/i.test(parts[1])) return; // header
      const imei = (parts[0]||'').trim();
      const name = (parts[1]||'').trim();
      const dept = (parts[2]||'').trim();
      const phone = (parts[3]||'').trim();
      if(!imei || !name) return;
      // avoid duplicates: update if exists else push
      const existing = employees.find(x => x.imei === imei);
      if(existing){
        existing.name = name; existing.dept = dept; existing.phone = phone;
      } else {
        employees.push({ imei, name, dept, phone });
      }
    });
    renderEmployees();
    log(`Employees imported (${lines.length} lines).`);
  };
  reader.readAsText(file);
}

/* download employee template */
document.getElementById('downloadEmpTemplate').addEventListener('click', ()=>{
  const csv = 'IMEI,Name,Dept,Phone\n356938035643809,John Doe,Service,9876543210\n';
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'employees_template.csv'; a.click();
  URL.revokeObjectURL(url);
});

/* ---------- depot select change -> show coords ---------- */
document.getElementById('depotSelect').addEventListener('change', e=>{
  const d = depots.find(x => x.name === e.target.value);
  document.getElementById('depotLatLng').value = d ? `${d.lat.toFixed(5)}, ${d.lng.toFixed(5)}` : '';
});

/* center depot button */
document.getElementById('centerDepot').addEventListener('click', ()=>{
  const dname = document.getElementById('depotSelect').value;
  const d = depots.find(x=>x.name===dname);
  if(d) map.setView([d.lat,d.lng], 14);
});

/* ---------- Tracking: Start / Stop / Clear ---------- */
document.getElementById('btnStart').addEventListener('click', ()=> {
  const empImei = document.getElementById('employeeSelect').value.trim();
  const imeiInput = document.getElementById('imei').value.trim();
  const depotName = document.getElementById('depotSelect').value.trim();

  if(!empImei){ alert('Select an employee from the list (IMEI will auto-fill).'); return; }
  if(!imeiInput){ alert('IMEI not set. Select an employee.'); return; }
  if(!depotName){ alert('Select a depot.'); return; }

  const emp = employees.find(e => e.imei === empImei);
  if(!emp){ alert('Selected employee not found. Re-import employees CSV if needed.'); return; }

  if(!navigator.geolocation){ alert('GPS not supported on this device.'); return; }

  // reset
  if(polyline){ map.removeLayer(polyline); polyline = null; }
  if(marker){ map.removeLayer(marker); marker = null; }
  path = []; totalDist = 0;

  document.getElementById('status').textContent = 'Tracking';
  const startTime = new Date();
  document.getElementById('tStart').textContent = startTime.toLocaleTimeString();
  document.getElementById('tEnd').textContent = '‚Äî';

  polyline = L.polyline([], { color: 'lime', weight: 4 }).addTo(map);
  const pin = L.icon({ iconUrl: 'https://cdn.vectorstock.com/i/1000x1000/64/11/man-‚Ä¶th-pin-pointer-location-icon-vector-25496411.webphttps://png.pngtree.com/png-clipart/20250103/original/pngtree-3d-location-markers-for-digital-maps-png-image_19845282.png', iconSize:[36,36] });

  currentRide = {
    date: todayStr(startTime),
    startISO: startTime.toISOString(),
    endISO: null,
    imei: imeiInput,
    employeeImei: empImei,
    employeeName: emp.name,
    dept: emp.dept,
    phone: emp.phone,
    depot: depotName,
    depotLat: depots.find(d=>d.name===depotName)?.lat || '',
    depotLng: depots.find(d=>d.name===depotName)?.lng || '',
    distance_m: 0,
    claim_inr: 0
  };

  watchId = navigator.geolocation.watchPosition(pos => {
    const latlng = [pos.coords.latitude, pos.coords.longitude];
    path.push(latlng);
    polyline.setLatLngs(path);
    if(!marker){ marker = L.marker(latlng, {icon:pin}).addTo(map); }
    else marker.setLatLng(latlng);
    map.setView(latlng, 15);

    document.getElementById('latlng').textContent = `${latlng[0].toFixed(5)}, ${latlng[1].toFixed(5)}`;
    if(path.length > 1){
      const last = path[path.length-2], curr = path[path.length-1];
      const d = map.distance(last, curr);
      totalDist += d;
      document.getElementById('dist').textContent = `${Math.round(totalDist)} m`;
      const claim = (totalDist/1000) * CLAIM_RATE_PER_KM;
      document.getElementById('claim').textContent = `‚Çπ${fmt2(claim)}`;
    }
    log(`GPS update ${latlng[0].toFixed(5)}, ${latlng[1].toFixed(5)}`);
  }, err => {
    alert('GPS error: ' + err.message);
  }, { enableHighAccuracy:true, maximumAge:1000, timeout:90000 });
});

document.getElementById('btnStop').addEventListener('click', ()=>{
  if(watchId){ navigator.geolocation.clearWatch(watchId); watchId = null; }
  document.getElementById('status').textContent = 'Stopped';
  const endTime = new Date();
  document.getElementById('tEnd').textContent = endTime.toLocaleTimeString();
  log('Tracking stopped.');

  if(currentRide){
    currentRide.endISO = endTime.toISOString();
    currentRide.distance_m = Math.round(totalDist);
    currentRide.claim_inr = +((totalDist/1000) * CLAIM_RATE_PER_KM).toFixed(2);

    const rides = loadRides();
    rides.push(currentRide);
    saveRides(rides);
    renderTodayTable();
  }
});

document.getElementById('btnClear').addEventListener('click', ()=> {
  if(watchId){ navigator.geolocation.clearWatch(watchId); watchId=null; }
  path=[]; totalDist=0;
  if(polyline){ map.removeLayer(polyline); polyline=null; }
  if(marker){ map.removeLayer(marker); marker=null; }
  document.getElementById('status').textContent='Idle';
  document.getElementById('latlng').textContent='‚Äî';
  document.getElementById('dist').textContent='0 m';
  document.getElementById('claim').textContent='‚Çπ0';
  document.getElementById('tStart').textContent='‚Äî';
  document.getElementById('tEnd').textContent='‚Äî';
  currentRide=null;
  log('Session cleared.');
});

/* ---------- CSV export (depot-wise) ---------- */
function csvEscape(val){
  if(val == null) return '';
  const s = String(val);
  if(s.includes(',') || s.includes('"') || s.includes('\n')) return `"${s.replace(/"/g,'""')}"`;
  return s;
}

function exportDepotCSVForDate(depotName, dateStr){
  const rides = loadRides().filter(r => r.depot === depotName && r.date === dateStr);
  const rows = [];
  rows.push(['Date','Depot','DepotLat','DepotLng','Employee','IMEI','Dept','Phone','Start','End','Distance(m)','Distance(km)','Claim(‚Çπ)']);
  rides.forEach(r=>{
    rows.push([
      r.date, r.depot, r.depotLat, r.depotLng, r.employeeName,
      r.imei, r.dept, r.phone,
      r.startISO ? new Date(r.startISO).toLocaleTimeString() : '',
      r.endISO ? new Date(r.endISO).toLocaleTimeString() : '',
      r.distance_m, (r.distance_m/1000).toFixed(3), r.claim_inr.toFixed(2)
    ]);
  });
  const csv = rows.map(r => r.map(csvEscape).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url;
  a.download = `${dateStr}_${depotName.replace(/\s+/g,'_')}_rides.csv`; a.click();
  URL.revokeObjectURL(url);
}

document.getElementById('renderDepotButtons').addEventListener('click', ()=> {
  const container = document.getElementById('depotExport');
  container.innerHTML = '';
  const dateStr = document.getElementById('exportDate').value || todayStr();
  depots.forEach(d => {
    const b = document.createElement('button');
    b.className = 'depot-btn';
    b.textContent = d.name;
    b.onclick = ()=> exportDepotCSVForDate(d.name, dateStr);
    container.appendChild(b);
  });
});

document.getElementById('exportTodayAll').addEventListener('click', ()=>{
  const dStr = todayStr();
  depots.forEach(d => exportDepotCSVForDate(d.name, dStr));
});

/* ---------- Admin auth ---------- */
function showLogin(){ document.getElementById('loginModal').style.display = 'flex'; }
function doLogin(){
  const u = document.getElementById('username').value.trim();
  const p = document.getElementById('password').value.trim();
  if(u === ADMIN_USER && p === ADMIN_PASS){
    document.getElementById('loginModal').style.display = 'none';
    document.getElementById('adminPanel').style.display = 'block';
    renderTodayTable();
    renderEmployees();
    log('Admin logged in');
  } else {
    document.getElementById('loginMsg').textContent = 'Invalid credentials!';
  }
}
function doLogout(){
  document.getElementById('adminPanel').style.display = 'none';
  document.getElementById('loginModal').style.display = 'flex';
  document.getElementById('username').value = '';
  document.getElementById('password').value = '';
  document.getElementById('loginMsg').textContent = '';
}

/* ---------- small niceties: allow reverse lookup if someone pastes IMEI (optional) ---------- */
document.getElementById('imei').addEventListener('input', ()=>{
  // keep readonly - but in case you remove readonly later, this will sync selection
  const imei = document.getElementById('imei').value.trim();
  if(!imei) return;
  const emp = employees.find(e => e.imei === imei);
  if(emp){
    document.getElementById('employeeSelect').value = emp.imei;
  }
});

/* ========== Init / Ready ========== */
document.getElementById('exportDate').value = todayStr();
renderEmployees();
renderDepots();
renderTodayTable();
log('App ready.');
</script>
</body>
</html>